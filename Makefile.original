# ä¸´æ—¶é‚®ç®±ç³»ç»Ÿ Makefile
# æä¾›å¼€å‘ã€æ„å»ºã€æµ‹è¯•ã€éƒ¨ç½²ç­‰å¸¸ç”¨å‘½ä»¤

# å˜é‡å®šä¹‰
APP_NAME := temp-mailbox-service
VERSION := $(shell git describe --tags --always --dirty 2>nul || echo "dev")
BUILD_TIME := $(shell powershell -Command "Get-Date -Format 'yyyy-MM-dd HH:mm'" 2>nul || echo "unknown")
GO_VERSION := $(shell go version 2>nul | powershell -Command "$$input.Split(' ')[2]" || echo "unknown")

# Go ç›¸å…³è·¯å¾„
BACKEND_DIR := backend
SERVER_MAIN := $(BACKEND_DIR)/cmd/server/main.go
WORKER_MAIN := $(BACKEND_DIR)/cmd/worker/main.go
BIN_DIR := $(BACKEND_DIR)/bin

# Docker ç›¸å…³
DOCKER_IMAGE := $(APP_NAME)
DOCKER_TAG := latest

# æ„å»ºæ ‡è®°
LDFLAGS := -X 'main.Version=$(VERSION)' \
           -X 'main.BuildTime=$(BUILD_TIME)' \
           -X 'main.GoVersion=$(GO_VERSION)'

.PHONY: help
help: ## æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
	@echo "ä¸´æ—¶é‚®ç®±ç³»ç»Ÿ - å¯ç”¨å‘½ä»¤:"
	@echo ""
	@powershell -Command "Get-Content Makefile | Select-String '##@|^[a-zA-Z_-]+:.*##' | ForEach-Object { if ($$_.Line -match '^##@(.*)') { Write-Host ''; Write-Host $$matches[1] -ForegroundColor Yellow } else { $$parts = $$_.Line -split ':.*?##'; if ($$parts.Length -eq 2) { Write-Host ('  {0,-15} {1}' -f $$parts[0], $$parts[1]) -ForegroundColor Cyan } } }"

##@ å¼€å‘å‘½ä»¤

.PHONY: setup
setup: ## åˆå§‹åŒ–å¼€å‘ç¯å¢ƒ
	@echo "ğŸ”§ åˆå§‹åŒ–å¼€å‘ç¯å¢ƒ..."
	@cd $(BACKEND_DIR) && go mod download
	@cd $(BACKEND_DIR) && go mod tidy
	@echo "âœ… å¼€å‘ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ"

.PHONY: dev
dev: ## å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼ˆçƒ­é‡è½½ï¼‰
	@echo "ğŸš€ å¯åŠ¨å¼€å‘æœåŠ¡å™¨..."
	@cd $(BACKEND_DIR) && air

.PHONY: run
run: ## ç›´æ¥è¿è¡ŒæœåŠ¡å™¨
	@echo "ğŸš€ å¯åŠ¨æœåŠ¡å™¨..."
	@cd $(BACKEND_DIR) && go run $(SERVER_MAIN)

.PHONY: worker
worker: ## è¿è¡Œåå°ä»»åŠ¡æœåŠ¡
	@echo "âš™ï¸ å¯åŠ¨åå°ä»»åŠ¡æœåŠ¡..."
	@cd $(BACKEND_DIR) && go run $(WORKER_MAIN)

##@ æ„å»ºå‘½ä»¤

.PHONY: build
build: build-server build-worker ## æ„å»ºæ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶

.PHONY: build-server
build-server: ## æ„å»ºæœåŠ¡å™¨äºŒè¿›åˆ¶æ–‡ä»¶
	@echo "ğŸ”¨ æ„å»ºæœåŠ¡å™¨..."
	@mkdir -p $(BIN_DIR)
	@cd $(BACKEND_DIR) && go build -ldflags="$(LDFLAGS)" -o bin/server cmd/server/main.go
	@echo "âœ… æœåŠ¡å™¨æ„å»ºå®Œæˆ: $(BIN_DIR)/server"

.PHONY: build-worker
build-worker: ## æ„å»ºåå°ä»»åŠ¡äºŒè¿›åˆ¶æ–‡ä»¶
	@echo "ğŸ”¨ æ„å»ºåå°ä»»åŠ¡æœåŠ¡..."
	@mkdir -p $(BIN_DIR)
	@cd $(BACKEND_DIR) && go build -ldflags="$(LDFLAGS)" -o bin/worker cmd/worker/main.go
	@echo "âœ… åå°ä»»åŠ¡æœåŠ¡æ„å»ºå®Œæˆ: $(BIN_DIR)/worker"

.PHONY: build-linux
build-linux: ## æ„å»ºLinuxç‰ˆæœ¬
	@echo "ğŸ§ æ„å»ºLinuxç‰ˆæœ¬..."
	@mkdir -p $(BIN_DIR)
	@cd $(BACKEND_DIR) && GOOS=linux GOARCH=amd64 go build -ldflags="$(LDFLAGS)" -o bin/server-linux cmd/server/main.go
	@cd $(BACKEND_DIR) && GOOS=linux GOARCH=amd64 go build -ldflags="$(LDFLAGS)" -o bin/worker-linux cmd/worker/main.go
	@echo "âœ… Linuxç‰ˆæœ¬æ„å»ºå®Œæˆ"

##@ æµ‹è¯•å‘½ä»¤

.PHONY: test
test: ## è¿è¡Œæ‰€æœ‰æµ‹è¯•
	@echo "ğŸ§ª è¿è¡Œæµ‹è¯•..."
	@cd $(BACKEND_DIR) && go test ./... -v

.PHONY: test-coverage
test-coverage: ## è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
	@echo "ğŸ“Š ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š..."
	@cd $(BACKEND_DIR) && go test ./... -coverprofile=coverage.out
	@cd $(BACKEND_DIR) && go tool cover -html=coverage.out -o coverage.html
	@echo "âœ… è¦†ç›–ç‡æŠ¥å‘Šç”Ÿæˆå®Œæˆ: $(BACKEND_DIR)/coverage.html"

.PHONY: test-race
test-race: ## è¿è¡Œç«æ€æ¡ä»¶æ£€æµ‹
	@echo "ğŸƒ è¿è¡Œç«æ€æ¡ä»¶æ£€æµ‹..."
	@cd $(BACKEND_DIR) && go test -race ./...

.PHONY: benchmark
benchmark: ## è¿è¡ŒåŸºå‡†æµ‹è¯•
	@echo "âš¡ è¿è¡ŒåŸºå‡†æµ‹è¯•..."
	@cd $(BACKEND_DIR) && go test -bench=. ./...

##@ æ•°æ®åº“å‘½ä»¤

.PHONY: db-migrate
db-migrate: ## æ‰§è¡Œæ•°æ®åº“è¿ç§»
	@echo "ğŸ—„ï¸ æ‰§è¡Œæ•°æ®åº“è¿ç§»..."
	@cd $(BACKEND_DIR) && go run scripts/migrate.go

.PHONY: db-seed
db-seed: ## å¡«å……æµ‹è¯•æ•°æ®
	@echo "ğŸŒ± å¡«å……æµ‹è¯•æ•°æ®..."
	@cd $(BACKEND_DIR) && go run scripts/seed.go

.PHONY: db-reset
db-reset: ## é‡ç½®æ•°æ®åº“ï¼ˆåˆ é™¤å¹¶é‡æ–°è¿ç§»ï¼‰
	@echo "ğŸ”„ é‡ç½®æ•°æ®åº“..."
	@if exist "$(BACKEND_DIR)\dev.db" del "$(BACKEND_DIR)\dev.db"
	@$(MAKE) db-migrate
	@$(MAKE) db-seed

##@ ä»£ç è´¨é‡

.PHONY: fmt
fmt: ## æ ¼å¼åŒ–ä»£ç 
	@echo "ğŸ’… æ ¼å¼åŒ–ä»£ç ..."
	@cd $(BACKEND_DIR) && go fmt ./...
	@echo "âœ… ä»£ç æ ¼å¼åŒ–å®Œæˆ"

.PHONY: lint
lint: ## è¿è¡Œä»£ç æ£€æŸ¥
	@echo "ğŸ” è¿è¡Œä»£ç æ£€æŸ¥..."
	@cd $(BACKEND_DIR) && golangci-lint run

.PHONY: vet
vet: ## è¿è¡Œgo vetæ£€æŸ¥
	@echo "ğŸ” è¿è¡Œé™æ€åˆ†æ..."
	@cd $(BACKEND_DIR) && go vet ./...

.PHONY: tidy
tidy: ## æ•´ç†ä¾èµ–
	@echo "ğŸ“¦ æ•´ç†ä¾èµ–..."
	@cd $(BACKEND_DIR) && go mod tidy

.PHONY: check
check: fmt vet lint test ## è¿è¡Œæ‰€æœ‰ä»£ç æ£€æŸ¥

##@ Dockerå‘½ä»¤

.PHONY: docker-build
docker-build: ## æ„å»ºDockeré•œåƒ
	@echo "ğŸ³ æ„å»ºDockeré•œåƒ..."
	@docker build -t $(DOCKER_IMAGE):$(DOCKER_TAG) -f $(BACKEND_DIR)/Dockerfile $(BACKEND_DIR)
	@echo "âœ… Dockeré•œåƒæ„å»ºå®Œæˆ: $(DOCKER_IMAGE):$(DOCKER_TAG)"

.PHONY: docker-build-dev
docker-build-dev: ## æ„å»ºå¼€å‘ç¯å¢ƒDockeré•œåƒ
	@echo "ğŸ³ æ„å»ºå¼€å‘ç¯å¢ƒDockeré•œåƒ..."
	@docker build -t $(DOCKER_IMAGE):dev -f $(BACKEND_DIR)/Dockerfile.dev $(BACKEND_DIR)

.PHONY: docker-up
docker-up: ## å¯åŠ¨Dockerå¼€å‘ç¯å¢ƒ
	@echo "ğŸ³ å¯åŠ¨Dockerå¼€å‘ç¯å¢ƒ..."
	@docker-compose -f docker-compose.dev.yml up -d

.PHONY: docker-down
docker-down: ## åœæ­¢Dockerå¼€å‘ç¯å¢ƒ
	@echo "ğŸ³ åœæ­¢Dockerå¼€å‘ç¯å¢ƒ..."
	@docker-compose -f docker-compose.dev.yml down

.PHONY: docker-logs
docker-logs: ## æŸ¥çœ‹Dockeræ—¥å¿—
	@docker-compose -f docker-compose.dev.yml logs -f

.PHONY: docker-clean
docker-clean: ## æ¸…ç†Dockerèµ„æº
	@echo "ğŸ§¹ æ¸…ç†Dockerèµ„æº..."
	@docker-compose -f docker-compose.dev.yml down -v
	@docker system prune -f

##@ éƒ¨ç½²å‘½ä»¤

.PHONY: deploy-prod
deploy-prod: ## éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
	@echo "ğŸš€ éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
	@docker-compose -f docker-compose.prod.yml up -d --build

.PHONY: deploy-stop
deploy-stop: ## åœæ­¢ç”Ÿäº§ç¯å¢ƒ
	@docker-compose -f docker-compose.prod.yml down

##@ å·¥å…·å‘½ä»¤

.PHONY: install-tools
install-tools: ## å®‰è£…å¼€å‘å·¥å…·
	@echo "ğŸ”§ å®‰è£…å¼€å‘å·¥å…·..."
	@go install github.com/cosmtrek/air@latest
	@go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
	@echo "âœ… å¼€å‘å·¥å…·å®‰è£…å®Œæˆ"

.PHONY: gen-env
gen-env: ## ç”Ÿæˆç¯å¢ƒé…ç½®æ–‡ä»¶
	@echo "ğŸ“ ç”Ÿæˆç¯å¢ƒé…ç½®æ–‡ä»¶..."
	@if not exist ".env.dev" ( \
		copy ".env.example" ".env.dev" >nul & \
		echo "âœ… åˆ›å»º .env.dev æ–‡ä»¶" \
	) else ( \
		echo "âš ï¸  .env.dev æ–‡ä»¶å·²å­˜åœ¨" \
	)

.PHONY: clean
clean: ## æ¸…ç†æ„å»ºæ–‡ä»¶
	@echo "ğŸ§¹ æ¸…ç†æ„å»ºæ–‡ä»¶..."
	@if exist "$(BIN_DIR)" rmdir /s /q "$(BIN_DIR)"
	@if exist "$(BACKEND_DIR)\coverage.out" del "$(BACKEND_DIR)\coverage.out"
	@if exist "$(BACKEND_DIR)\coverage.html" del "$(BACKEND_DIR)\coverage.html"
	@if exist "$(BACKEND_DIR)\*.log" del "$(BACKEND_DIR)\*.log"
	@echo "âœ… æ¸…ç†å®Œæˆ"

.PHONY: version
version: ## æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯
	@echo "ç‰ˆæœ¬ä¿¡æ¯:"
	@echo "  åº”ç”¨ç‰ˆæœ¬: $(VERSION)"
	@echo "  æ„å»ºæ—¶é—´: $(BUILD_TIME)"
	@echo "  Goç‰ˆæœ¬:  $(GO_VERSION)"

##@ å¿«é€Ÿå‘½ä»¤ç»„åˆ

.PHONY: quick-start
quick-start: gen-env docker-up ## å¿«é€Ÿå¯åŠ¨å¼€å‘ç¯å¢ƒ
	@echo "ğŸ‰ å¼€å‘ç¯å¢ƒå·²å¯åŠ¨ï¼"
	@echo "ğŸ’¡ æç¤º:"
	@echo "   - åç«¯API: http://localhost:8080"
	@echo "   - æ•°æ®åº“å·²åœ¨Dockerä¸­è¿è¡Œ"
	@echo "   - ä½¿ç”¨ 'make dev' å¯åŠ¨çƒ­é‡è½½å¼€å‘æœåŠ¡å™¨"

.PHONY: quick-test
quick-test: fmt vet test ## å¿«é€Ÿæµ‹è¯•ï¼ˆæ ¼å¼åŒ– + æ£€æŸ¥ + æµ‹è¯•ï¼‰

.PHONY: quick-build
quick-build: clean build ## å¿«é€Ÿæ„å»ºï¼ˆæ¸…ç† + æ„å»ºï¼‰

# é»˜è®¤ç›®æ ‡
.DEFAULT_GOAL := help 